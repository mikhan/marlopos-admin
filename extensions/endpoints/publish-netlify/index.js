const e=require("https");module.exports=async function(t,{services:n,env:r}){const s=r.NETLIFY_TOKEN,o=r.NETLIFY_SITE;let i;function a(e,t,n){e.accountability.admin?n():t.status(401).send({error:"You must be logged in with admin privileges"})}async function c(){if(!i){let e=await u();i=e?e.site_id:void 0}return i}function u(){return new Promise((async function(e,t){try{const n=await d(`/sites?name=${o}`);let r=n&&1===n.length?n[0]:void 0;return r?e(r):t("The configured Netlify site could not be found")}catch(e){return t(e)}}))}async function d(e){return await y("GET",e,void 0)}async function l(e,t){return await y("POST",e,t)}async function y(t,n,r){return new Promise((function(o,i){let a={Authorization:"Bearer "+s};r&&(r=JSON.stringify(r),a["Content-Type"]="application/json",a["Content-Length"]=r.length);const c={headers:a,method:t,hostname:"api.netlify.com",path:"/api/v1/"+n,port:443},u=e.request(c,(function(e){let t=e.statusCode;if(t&&(t<200||t>=300))return i(new Error("Netlify API Request Failed ["+t+"]"));let n=[];e.on("data",(function(e){n.push(e)})),e.on("end",(function(){try{n=JSON.parse(Buffer.concat(n).toString())}catch(e){return i(new Error("Netlify API Request Failed ["+e+"]"))}return o(n)}))}));u.on("error",(function(e){return console.log("Could not make Netlify API Request ["+e+"]"),i(e)})),r&&u.write(r),u.end()}))}t.get("/site",a,(async function(e,t){if(!s||""===s)return t.send({error:"NETLIFY_TOKEN environment variable not set"});if(!o||""===o)return t.send({error:"NETLIFY_SITE environment variable not set"});try{const e=await u();return t.send({site:e})}catch(e){return t.send({error:e.message})}})),t.get("/deploys",a,(async function(e,t){try{const e=await c(),n=await d(`/sites/${e}/deploys?per_page=25`);return t.send({deploys:n})}catch(e){return t.send({error:e.message})}})),t.post("/builds",a,(async function(e,t){try{const e=await c(),n=await l(`/sites/${e}/builds`);return t.send({build:n})}catch(e){return t.send({error:e.message})}})),t.post("/lock",a,(async function(e,t){try{const e=await u(),n=await l(`/deploys/${e.published_deploy.id}/lock`);return t.send({success:n&&n.locked})}catch(e){return t.send({error:e.message})}})),t.post("/unlock",a,(async function(e,t){try{const e=await u(),n=await l(`/deploys/${e.published_deploy.id}/unlock`);return t.send({success:n&&!n.locked})}catch(e){return t.send({error:e.message})}})),t.post("/publish/:deploy_id",a,(async function(e,t){try{const n=await c(),r=await l(`/sites/${n}/deploys/${e.params.deploy_id}/restore`);return t.send({deploy:r})}catch(e){return t.send({error:e.message})}}))};
